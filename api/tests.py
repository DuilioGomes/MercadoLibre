from django.test import TestCase

from .calls import get_publications_category
from .normalize import normalize_most_expensive


class TestNormalize(TestCase):

    def setUp(self):
        self.data = {'site_id': 'MLA', 'paging': {'total': 1133, 'primary_results': 1000, 'offset': 0, 'limit': 2}, 'results': [{'id': 'MLA885192748', 'site_id': 'MLA', 'title': 'Apple Smart Battery Case iPhone 11 - Funda Cargadora - Negro', 'seller': {'id': 99784588, 'permalink': 'http://perfil.mercadolibre.com.ar/M+H+S', 'registration_date': '2010-10-28T19:25:56.000-04:00', 'car_dealer': False, 'real_estate_agency': False, 'tags': ['normal', 'user_info_verified', 'credits_profile', 'messages_as_seller', 'messages_as_buyer'], 'seller_reputation': {'transactions': {'total': 9, 'canceled': 1, 'period': 'historic', 'ratings': {'negative': 0, 'positive': 1, 'neutral': 0}, 'completed': 8}, 'power_seller_status': None, 'metrics': {'claims': {'rate': 0, 'value': 1, 'period': '365 days'}, 'delayed_handling_time': {'rate': 0, 'value': 1, 'period': '365 days'}, 'sales': {'period': '365 days', 'completed': 8}, 'cancellations': {'rate': 0, 'value': 0, 'period': '365 days'}}, 'level_id': None}}, 'price': 65000, 'prices': {'id': 'MLA885192748', 'prices': [{'id': 'e5abd87f-050c-4557-9ee7-1cf6224bb332', 'type': 'standard', 'conditions': {'context_restrictions': [], 'start_time': None, 'end_time': None, 'eligible': True}, 'amount': 65000, 'regular_amount': None, 'currency_id': 'ARS', 'exchange_rate_context': 'DEFAULT', 'metadata': {}, 'last_updated': '2020-11-19T14:30:57Z'}], 'presentation': {'display_currency': 'ARS'}, 'payment_method_prices': []}, 'sale_price': None, 'currency_id': 'ARS', 'available_quantity': 1, 'sold_quantity': 0, 'buying_mode': 'buy_it_now', 'listing_type_id': 'gold_pro', 'stop_time': '2040-10-26T00:43:06.000Z', 'condition': 'new', 'permalink': 'https://articulo.mercadolibre.com.ar/MLA-885192748-apple-smart-battery-case-iphone-11-funda-cargadora-negro-_JM', 'thumbnail': 'http://http2.mlstatic.com/D_842591-MLA43851907142_102020-I.jpg', 'thumbnail_id': '842591-MLA43851907142_102020', 'accepts_mercadopago': True, 'installments': {'quantity': 9, 'amount': 7222.22, 'rate': 0, 'currency_id': 'ARS'}, 'address': {'state_id': 'AR-B', 'state_name': 'Buenos Aires', 'city_id': None, 'city_name': 'Ramos Mejia'}, 'shipping': {'free_shipping': True, 'mode': 'me2', 'tags': ['mandatory_free_shipping'], 'logistic_type': 'drop_off', 'store_pick_up': False}, 'seller_address': {'id': '', 'comment': '', 'address_line': '', 'zip_code': '', 'country': {'id': 'AR', 'name': 'Argentina'}, 'state': {'id': 'AR-B', 'name': 'Buenos Aires'}, 'city': {'id': None, 'name': 'Ramos Mejia'}, 'latitude': '', 'longitude': ''}, 'attributes': [{'attribute_group_name': 'Otros', 'value_id': '9344', 'value_name': 'Apple', 'value_struct': None, 'attribute_group_id': 'OTHERS', 'id': 'BRAND', 'name': 'Marca', 'values': [{'id': '9344', 'name': 'Apple', 'struct': None, 'source': 6808261514773724}], 'source': 6808261514773724}, {'value_name': 'Nuevo', 'value_struct': None, 'values': [{'name': 'Nuevo', 'struct': None, 'source': 6808261514773724, 'id': '2230284'}], 'source': 6808261514773724, 'id': 'ITEM_CONDITION', 'name': 'Condición del ítem', 'value_id': '2230284', 'attribute_group_id': 'OTHERS', 'attribute_group_name': 'Otros'}, {'value_id': None, 'values': [{'source': 6808261514773724, 'id': None, 'name': 'Smart Case', 'struct': None}], 'attribute_group_id': 'OTHERS', 'value_struct': None, 'attribute_group_name': 'Otros', 'source': 6808261514773724, 'id': 'MODEL', 'name': 'Modelo', 'value_name': 'Smart Case'}], 'differential_pricing': {'id': 33678187}, 'original_price': None, 'category_id': 'MLA420040', 'official_store_id': None, 'domain_id': 'MLA-CELLPHONE_BATTERY_CASES', 'catalog_product_id': None, 'tags': ['good_quality_picture', 'good_quality_thumbnail', 'immediate_payment', 'cart_eligible'], 'order_backend': 1, 'use_thumbnail_id': True}, {'id': 'MLA886587312', 'site_id': 'MLA', 'title': 'Funda Cargadora iPhone 11 Original Apple', 'seller': {'id': 565108857, 'permalink': 'http://perfil.mercadolibre.com.ar/TAEL744943', 'registration_date': '2020-05-08T08:24:10.000-04:00', 'car_dealer': False, 'real_estate_agency': False, 'tags': ['normal', 'user_info_verified', 'messages_as_seller'], 'seller_reputation': {'transactions': {'total': 58, 'canceled': 9, 'period': 'historic', 'ratings': {'negative': 0.02, 'positive': 0.98, 'neutral': 0}, 'completed': 49}, 'power_seller_status': None, 'metrics': {'claims': {'rate': 0, 'value': 1, 'period': '365 days'}, 'delayed_handling_time': {'rate': 0.1315, 'value': 5, 'period': '365 days'}, 'sales': {'period': '365 days', 'completed': 49}, 'cancellations': {'rate': 0, 'value': 0, 'period': '365 days'}}, 'level_id': '5_green'}}, 'price': 59999, 'prices': {'id': 'MLA886587312', 'prices': [{'id': '3b592281-c959-4c60-b1f8-e08a33bf02ea', 'type': 'standard', 'conditions': {'context_restrictions': [], 'start_time': None, 'end_time': None, 'eligible': True}, 'amount': 59999, 'regular_amount': None, 'currency_id': 'ARS', 'exchange_rate_context': 'DEFAULT', 'metadata': {}, 'last_updated': '2020-11-03T14:30:55Z'}], 'presentation': {'display_currency': 'ARS'}, 'payment_method_prices': []}, 'sale_price': None, 'currency_id': 'ARS', 'available_quantity': 1, 'sold_quantity': 0, 'buying_mode': 'buy_it_now', 'listing_type_id': 'gold_special', 'stop_time': '2040-10-29T04:00:00.000Z', 'condition': 'new', 'permalink': 'https://articulo.mercadolibre.com.ar/MLA-886587312-funda-cargadora-iphone-11-original-apple-_JM', 'thumbnail': 'http://http2.mlstatic.com/D_633818-MLA43977872062_112020-I.jpg', 'thumbnail_id': '633818-MLA43977872062_112020', 'accepts_mercadopago': True, 'installments': {'quantity': 12, 'amount': 8508.36, 'rate': 70.17, 'currency_id': 'ARS'}, 'address': {'state_id': 'AR-C', 'state_name': 'Capital Federal', 'city_id': None, 'city_name': 'Recoleta'}, 'shipping': {'free_shipping': True, 'mode': 'me2', 'tags': ['mandatory_free_shipping'], 'logistic_type': 'drop_off', 'store_pick_up': False}, 'seller_address': {'id': '', 'comment': '', 'address_line': '', 'zip_code': '', 'country': {'id': 'AR', 'name': 'Argentina'}, 'state': {'id': 'AR-C', 'name': 'Capital Federal'}, 'city': {'id': None, 'name': 'Recoleta'}, 'latitude': '', 'longitude': ''}, 'attributes': [{'value_name': 'Nuevo', 'source': 7092, 'value_id': '2230284', 'name': 'Condición del ítem', 'value_struct': None, 'values': [{'source': 7092, 'id': '2230284', 'name': 'Nuevo', 'struct': None}], 'attribute_group_id': 'OTHERS', 'attribute_group_name': 'Otros', 'id': 'ITEM_CONDITION'}], 'original_price': None, 'category_id': 'MLA420040', 'official_store_id': None, 'domain_id': 'MLA-CELLPHONE_BATTERY_CASES', 'catalog_product_id': None, 'tags': ['good_quality_picture', 'good_quality_thumbnail', 'incomplete_technical_specs', 'immediate_payment', 'cart_eligible'], 'order_backend': 2, 'use_thumbnail_id': True}], 'secondary_results': [], 'related_results': [], 'sort': {'id': 'price_desc', 'name': 'Mayor precio'}, 'available_sorts': [{'id': 'relevance', 'name': 'Más relevantes'}, {'id': 'price_asc', 'name': 'Menor precio'}], 'filters': [{'id': 'category', 'name': 'Categorías', 'type': 'text', 'values': [{'id': 'MLA420040', 'name': 'Fundas Cargadoras', 'path_from_root': [{'id': 'MLA1051', 'name': 'Celulares y Teléfonos'}, {'id': 'MLA3502', 'name': 'Accesorios para Celulares'}, {'id': 'MLA3517', 'name': 'Cargadores'}, {'id': 'MLA420040', 'name': 'Fundas Cargadoras'}]}]}], 'available_filters': [{'id': 'official_store', 'name': 'Tiendas oficiales', 'type': 'text', 'values': [{'id': 'all', 'name': 'Todas las tiendas oficiales', 'results': 13}, {'id': '998', 'name': 'The iCase', 'results': 9}, {'id': '1760', 'name': 'Mophie', 'results': 3}]}, {'id': 'discount', 'name': 'Descuentos', 'type': 'range', 'values': [{'id': '5-100', 'name': 'Desde 5% OFF', 'results': 19}, {'id': '10-100', 'name': 'Desde 10% OFF', 'results': 10}]}, {'id': 'state', 'name': 'Ubicación', 'type': 'text', 'values': [{'id': 'TUxBUENBUGw3M2E1', 'name': 'Capital Federal', 'results': 573}, {'id': 'TUxBUEdSQWU4ZDkz', 'name': 'Bs.As. G.B.A. Norte', 'results': 428}, {'id': 'TUxBUEdSQXJlMDNm', 'name': 'Bs.As. G.B.A. Sur', 'results': 44}, {'id': 'TUxBUEdSQWVmNTVm', 'name': 'Bs.As. G.B.A. Oeste', 'results': 37}, {'id': 'TUxBUFpPTmFpbnRl', 'name': 'Buenos Aires Interior', 'results': 8}, {'id': 'TUxBUFNBTmU5Nzk2', 'name': 'Santa Fe', 'results': 6}, {'id': 'TUxBUFRVQ244NmM3', 'name': 'Tucumán', 'results': 5}, {'id': 'TUxBUENPU2ExMmFkMw', 'name': 'Bs.As. Costa Atlántica', 'results': 4}, {'id': 'TUxBUENPUmFkZGIw', 'name': 'Córdoba', 'results': 4}, {'id': 'TUxBUE1FTmE5OWQ4', 'name': 'Mendoza', 'results': 2}, {'id': 'TUxBUE1JU3MzNjIx', 'name': 'Misiones', 'results': 2}, {'id': 'TUxBUEVOVHMzNTdm', 'name': 'Entre Ríos', 'results': 2}, {'id': 'TUxBUFNBTm5lYjU4', 'name': 'San Juan', 'results': 2}, {'id': 'TUxBUFNBTm9lOTlk', 'name': 'Santiago del Estero', 'results': 2}, {'id': 'TUxBUENIQW8xMTNhOA', 'name': 'Chaco', 'results': 1}, {'id': 'TUxBUExBWmE1OWMy', 'name': 'La Pampa', 'results': 1}, {'id': 'TUxBUFNBTGFjMTJi', 'name': 'Salta', 'results': 1}]}, {'id': 'price', 'name': 'Precio', 'type': 'range', 'values': [{'id': '*-5000.0', 'name': 'Hasta $ 5.000', 'results': 374}, {'id': '5000.0-9500.0', 'name': '$5.000 a $9.500', 'results': 347}, {'id': '9500.0-*', 'name': 'Más de $9.500', 'results': 412}]}, {'id': 'accepts_mercadopago', 'name': 'Filtro por MercadoPago', 'type': 'boolean', 'values': [{'id': 'yes', 'name': 'Con MercadoPago', 'results': 1133}]}, {'id': 'installments', 'name': 'Pago', 'type': 'text', 'values': [{'id': 'yes', 'name': 'En cuotas', 'results': 1133}, {'id': 'no_interest', 'name': 'Sin interés', 'results': 88}]}, {'id': 'shipping', 'name': 'Tipo de entrega', 'type': 'text', 'values': [{'id': 'mercadoenvios', 'name': 'Con envío', 'results': 799}, {'id': 'fulfillment', 'name': 'Full', 'results': 29}]}, {'id': 'power_seller', 'name': 'Filtro por calidad de vendedores', 'type': 'boolean', 'values': [{'id': 'yes', 'name': 'Mejores vendedores', 'results': 845}]}, {'id': 'since', 'name': 'Filtro por fecha de comienzo', 'type': 'text', 'values': [{'id': 'today', 'name': 'Publicados hoy', 'results': 4}]}, {'id': 'has_video', 'name': 'Filtro por publicaciones con video', 'type': 'boolean', 'values': [{'id': 'yes', 'name': 'Publicaciones con video', 'results': 10}]}, {'id': 'has_pictures', 'name': 'Filtro por publicaciones con imágenes', 'type': 'boolean', 'values': [{'id': 'yes', 'name': 'Con fotos', 'results': 1133}]}, {'id': 'price_campaign_id', 'name': 'Campaña', 'type': 'number', 'values': [{'id': 'MLA5734', 'name': 'MLA5734', 'results': 1}]}, {'id': 'shipping_cost', 'name': 'Costo de envío', 'type': 'text', 'values': [{'id': 'free', 'name': 'Gratis', 'results': 763}]}, {'id': 'ITEM_CONDITION', 'name': 'Condición', 'type': 'STRING', 'values': [{'id': '2230284', 'name': 'Nuevo', 'results': 967}, {'id': '2230581', 'name': 'Usado', 'results': 166}]}]}  # noqa
        self.response = [{'title': 'Apple Smart Battery Case iPhone 11 - Funda Cargadora - Negro', 'price': 65000, 'link': 'https://articulo.mercadolibre.com.ar/MLA-885192748-apple-smart-battery-case-iphone-11-funda-cargadora-negro-_JM'}, {'title': 'Funda Cargadora iPhone 11 Original Apple', 'price': 59999, 'link': 'https://articulo.mercadolibre.com.ar/MLA-886587312-funda-cargadora-iphone-11-original-apple-_JM'}]  #noqa

    def test_normalize_most_expensive(self):
        self.assertEquals(normalize_most_expensive(self.data), self.response)

    def test_normalize_most_expensive_with_call(self):
        response = get_publications_category("MLA420040", sort="price_desc", limit="2")
        self.assertEquals(normalize_most_expensive(response.json()), self.response)


class TestCalls(TestCase):

    def test_get_publications_category(self):
        response = get_publications_category("MLA420040", sort="price_desc", limit="2")
        self.assertEquals(response.status_code, 200)


class TestView(TestCase):

    def test_view_most_expensive(self):
        response = self.client.get('/most_expensive/')
        self.assertEquals(response.status_code, 200)

    def test_view_biggest_sellers(self):
        response = self.client.get('/biggest_sellers/')
        self.assertEquals(response.status_code, 200)

    def test_view_home(self):
        response = self.client.get('')
        self.assertEquals(response.status_code, 200)
